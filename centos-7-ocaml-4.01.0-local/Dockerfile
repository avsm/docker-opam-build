# OPAM for centos-7 with local switch of OCaml 4.01.0
# Autogenerated by OCaml-Dockerfile scripts
FROM avsm/docker-ocaml-build:centos-7
MAINTAINER Anil Madhavapeddy <anil@recoil.org>
RUN git config --global user.email "docker@example.com"
RUN git config --global user.name "Docker CI"
RUN sh -c "git clone git://github.com/avsm/opam-installext && cd opam-installext && make && make PREFIX=/usr install && cd .. && rm -rf opam-installext"
RUN git clone -b 1.2 git://github.com/ocaml/opam
RUN sh -c "cd opam && make cold && make install"
RUN sed -i.bak '/LC_TIME LC_ALL LANGUAGE/aDefaults    env_keep += "OPAMYES OPAMJOBS OPAMVERBOSE"' /etc/sudoers
RUN echo 'opam ALL=(ALL:ALL) NOPASSWD:ALL' > /etc/sudoers.d/opam
RUN chmod 440 /etc/sudoers.d/opam
RUN chown root:root /etc/sudoers.d/opam
RUN sed -i.bak 's/^Defaults.*requiretty//g' /etc/sudoers
RUN useradd -d /home/opam -m -s /bin/bash opam
RUN passwd -l opam
RUN chown -R opam:opam /home/opam
USER opam
ENV HOME /home/opam
WORKDIR /home/opam
ENV OPAMYES 1
RUN sudo -u opam sh -c "git clone git://github.com/ocaml/opam-repository"
RUN sudo -u opam sh -c "opam init -a -y /home/opam/opam-repository"
RUN sudo -u opam sh -c "opam switch -y 4.01.0"
WORKDIR /home/opam/opam-repository
RUN sudo -u opam sh -c "opam config exec -- ocaml -version"
RUN sudo -u opam sh -c "opam --version"
ONBUILD RUN sudo -u opam sh -c "cd /home/opam/opam-repository && git pull && opam update -u -y"